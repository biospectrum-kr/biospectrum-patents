name: Update Patents & Papers Data

permissions:
  contents: write   # GitHub Actions가 repo에 push 가능하도록 설정

on:
  schedule:
    - cron: '0 1 * * *'     # 매일 오전 10시 (KST)
  workflow_dispatch:        # 수동 실행 허용

jobs:
  update-data:
    runs-on: ubuntu-latest

    steps:
      # --------------------------------------
      # 1. Repo 체크아웃
      # --------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # --------------------------------------
      # 2. data 디렉토리 생성
      # --------------------------------------
      - name: Create data directory
        run: mkdir -p data

      # --------------------------------------
      # 3. Google Drive → patents.json 다운로드
      # --------------------------------------
      - name: Download patents.json from Google Drive
        env:
          GOOGLE_PATENTS_ID: ${{ secrets.GOOGLE_PATENTS_ID }}
        run: |
          echo "Downloading patents.json..."
          curl -L -o data/patents.json "https://drive.google.com/uc?export=download&id=${GOOGLE_PATENTS_ID}"

      # --------------------------------------
      # 4. Google Drive → papers.json 다운로드
      # --------------------------------------
      - name: Download papers.json from Google Drive
        env:
          GOOGLE_PAPERS_ID: ${{ secrets.GOOGLE_PAPERS_ID }}
        run: |
          echo "Downloading papers.json..."
          curl -L -o data/papers.json "https://drive.google.com/uc?export=download&id=${GOOGLE_PAPERS_ID}"

      # --------------------------------------
      # 5. BOM 제거
      # --------------------------------------
      - name: Remove BOM if exists
        run: |
          sed -i '1s/^\xEF\xBB\xBF//' data/patents.json || true
          sed -i '1s/^\xEF\xBB\xBF//' data/papers.json || true

      # --------------------------------------
      # 6. JSON 유효성 검사
      # --------------------------------------
      - name: Validate JSON files
        run: |
          if ! command -v jq &> /dev/null; then
            sudo apt-get update
            sudo apt-get install -y jq
          fi

          echo "Validating patents.json..."
          jq empty data/patents.json

          echo "Validating papers.json..."
          jq empty data/papers.json

      # --------------------------------------
      # 7. Commit & Push
      # --------------------------------------
      - name: Commit & Push changes
        run: |
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git config user.name "github-actions[bot]"
          
          git add data/patents.json
          git add data/papers.json

          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Auto-update patents & papers data"
            git push
            echo "Update complete"
          fi
