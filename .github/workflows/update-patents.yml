name: Update Patents Data

on:
  # ë§¤ì¼ ì˜¤ì „ 10ì‹œ (KST) ìë™ ì‹¤í–‰
  schedule:
    - cron: '0 1 * * *'  # UTC 01:00 = KST 10:00
  
  # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥
  workflow_dispatch:

jobs:
  update-patents:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup UTF-8 environment
        run: |
          echo "LC_ALL=en_US.UTF-8" >> $GITHUB_ENV
          echo "LANG=en_US.UTF-8" >> $GITHUB_ENV
          echo "âœ… UTF-8 í™˜ê²½ ì„¤ì • ì™„ë£Œ"
      
      - name: Create data directory
        run: |
          mkdir -p data
          echo "ğŸ“ data í´ë” ìƒì„±"
      
      - name: Download from Google Drive
        env:
          GOOGLE_FILE_ID: ${{ secrets.GOOGLE_FILE_ID }}
        run: |
          echo "ğŸ“¥ êµ¬ê¸€ ë“œë¼ì´ë¸Œì—ì„œ ë‹¤ìš´ë¡œë“œ ì¤‘..."
          
          # êµ¬ê¸€ ë“œë¼ì´ë¸Œì—ì„œ ë‹¤ìš´ë¡œë“œ
          curl -L "https://drive.google.com/uc?export=download&id=${GOOGLE_FILE_ID}" \
            --output data/patents.json \
            --silent \
            --show-error \
            --fail
          
          if [ -f data/patents.json ]; then
            echo "âœ… ë‹¤ìš´ë¡œë“œ ì™„ë£Œ"
            
            # íŒŒì¼ í¬ê¸° í™•ì¸
            FILE_SIZE=$(wc -c < data/patents.json)
            echo "ğŸ“„ íŒŒì¼ í¬ê¸°: ${FILE_SIZE} bytes"
            
            if [ "$FILE_SIZE" -lt 100 ]; then
              echo "âŒ íŒŒì¼ì´ ë„ˆë¬´ ì‘ìŠµë‹ˆë‹¤. ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨ì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤."
              exit 1
            fi
          else
            echo "âŒ íŒŒì¼ ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨"
            exit 1
          fi
      
      - name: Remove BOM if exists
        run: |
          if [ -f data/patents.json ]; then
            # UTF-8 BOM ì œê±° (0xEF 0xBB 0xBF)
            sed -i '1s/^\xEF\xBB\xBF//' data/patents.json
            echo "âœ… BOM ì œê±° ì™„ë£Œ"
          fi
      
      - name: Verify JSON format and Korean text
        run: |
          echo "ğŸ” JSON í˜•ì‹ ê²€ì¦ ì¤‘..."
          
          # jq ì„¤ì¹˜ í™•ì¸
          if ! command -v jq &> /dev/null; then
            echo "jq ì„¤ì¹˜ ì¤‘..."
            sudo apt-get update -qq
            sudo apt-get install -y jq
          fi
          
          # JSON ìœ íš¨ì„± ê²€ì‚¬
          if jq empty data/patents.json 2>/dev/null; then
            echo "âœ… JSON í˜•ì‹ ì •ìƒ"
            
            # ë°ì´í„° ê°œìˆ˜ í™•ì¸
            DOMESTIC_COUNT=$(jq '.domesticReg | length' data/patents.json)
            INTERNATIONAL_COUNT=$(jq '.internationalReg | length' data/patents.json)
            echo "ğŸ“Š êµ­ë‚´ íŠ¹í—ˆ: ${DOMESTIC_COUNT}ê±´"
            echo "ğŸ“Š í•´ì™¸ íŠ¹í—ˆ: ${INTERNATIONAL_COUNT}ê±´"
            
            # í•œê¸€ ì¸ì½”ë”© í™•ì¸
            if grep -q "íŠ¹í—ˆ" data/patents.json || grep -q "ë“±ë¡" data/patents.json; then
              echo "âœ… í•œê¸€ ì¸ì½”ë”© ì •ìƒ"
            else
              echo "âš ï¸ í•œê¸€ì´ í¬í•¨ë˜ì§€ ì•Šì•˜ê±°ë‚˜ ì¸ì½”ë”© ë¬¸ì œ ê°€ëŠ¥ì„±"
              # ì²« 10ì¤„ ì¶œë ¥ (ë””ë²„ê¹…ìš©)
              echo "íŒŒì¼ ë‚´ìš© ë¯¸ë¦¬ë³´ê¸°:"
              head -n 10 data/patents.json
            fi
            
            # ì²« ë²ˆì§¸ íŠ¹í—ˆ ì œëª© ì¶œë ¥ (í™•ì¸ìš©)
            FIRST_TITLE=$(jq -r '.domesticReg[0].title // "ì—†ìŒ"' data/patents.json)
            echo "ğŸ“„ ì²« ë²ˆì§¸ íŠ¹í—ˆ: ${FIRST_TITLE}"
            
          else
            echo "âŒ JSON í˜•ì‹ ì˜¤ë¥˜"
            echo "íŒŒì¼ ë‚´ìš©:"
            cat data/patents.json
            exit 1
          fi
      
      - name: Commit and push if changed
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          # ë³€ê²½ì‚¬í•­ ì¶”ê°€
          git add data/patents.json
          
          # ë³€ê²½ì‚¬í•­ í™•ì¸
          if git diff --staged --quiet; then
            echo "ğŸ“­ ë³€ê²½ì‚¬í•­ ì—†ìŒ - ì»¤ë°‹ ìƒëµ"
          else
            # í˜„ì¬ ì‹œê°„ (KST)
            COMMIT_TIME=$(TZ=Asia/Seoul date +'%Y-%m-%d %H:%M:%S')
            
            # ì»¤ë°‹ ë©”ì‹œì§€ì— í†µê³„ í¬í•¨
            DOMESTIC_COUNT=$(jq '.domesticReg | length' data/patents.json)
            INTERNATIONAL_COUNT=$(jq '.internationalReg | length' data/patents.json)
            
            git commit -m "ğŸ”„ Update patents data

ğŸ“Š êµ­ë‚´: ${DOMESTIC_COUNT}ê±´ | í•´ì™¸: ${INTERNATIONAL_COUNT}ê±´
ğŸ• ì—…ë°ì´íŠ¸: ${COMMIT_TIME} KST"
            
            git push
            echo "âœ… GitHubì— ì—…ë°ì´íŠ¸ ì™„ë£Œ!"
          fi
      
      - name: Summary
        if: always()
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“‹ ì‘ì—… ì™„ë£Œ ìš”ì•½"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          if [ -f data/patents.json ]; then
            DOMESTIC_COUNT=$(jq '.domesticReg | length' data/patents.json 2>/dev/null || echo "0")
            INTERNATIONAL_COUNT=$(jq '.internationalReg | length' data/patents.json 2>/dev/null || echo "0")
            LAST_UPDATED=$(jq -r '.lastUpdated // "ì•Œ ìˆ˜ ì—†ìŒ"' data/patents.json 2>/dev/null || echo "ì•Œ ìˆ˜ ì—†ìŒ")
            
            echo "âœ… íŒŒì¼: data/patents.json"
            echo "ğŸ“Š êµ­ë‚´ íŠ¹í—ˆ: ${DOMESTIC_COUNT}ê±´"
            echo "ğŸ“Š í•´ì™¸ íŠ¹í—ˆ: ${INTERNATIONAL_COUNT}ê±´"
            echo "ğŸ• ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸: ${LAST_UPDATED}"
            echo ""
            echo "ğŸŒ Raw URL:"
            echo "https://raw.githubusercontent.com/biospectrum-kr/biospectrum-patents/main/data/patents.json"
          else
            echo "âŒ íŒŒì¼ ìƒì„± ì‹¤íŒ¨"
          fi
          
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
