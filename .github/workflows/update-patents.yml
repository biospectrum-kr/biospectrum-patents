name: Update Patents Data

permissions:
  contents: write   # ğŸ”¥ GitHub Actionsê°€ push í•  ìˆ˜ ìˆê²Œ í•˜ëŠ” í•µì‹¬ ì„¤ì •

on:
  schedule:
    - cron: '0 1 * * *'   # ë§¤ì¼ 10ì‹œ (KST: +9)
  workflow_dispatch:      # ìˆ˜ë™ ì‹¤í–‰ í—ˆìš©

jobs:
  update-patents:
    runs-on: ubuntu-latest
    
    steps:
      # --------------------------------------
      # 1. ì „ì²´ íˆìŠ¤í† ë¦¬ë¥¼ ê°€ì ¸ì™€ì•¼ push/pull ê°€ëŠ¥
      # --------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0   # ğŸ”¥ Fast-forward, rebase, merge ëª¨ë‘ ê°€ëŠ¥í•´ì§

      # --------------------------------------
      # 2. ë°ì´í„° í´ë” ìƒì„±
      # --------------------------------------
      - name: Create data directory
        run: mkdir -p data
      
      # --------------------------------------
      # 3. Google Driveì—ì„œ íŒŒì¼ ë‹¤ìš´ë¡œë“œ
      # --------------------------------------
      - name: Download from Google Drive
        env:
          GOOGLE_FILE_ID: ${{ secrets.GOOGLE_FILE_ID }}
        run: |
          curl -L "https://drive.google.com/uc?export=download&id=${GOOGLE_FILE_ID}" \
            -o data/patents.json
          
          if [ -f data/patents.json ]; then
            echo "Download complete"
            ls -lh data/patents.json
          else
            echo "Download failed"
            exit 1
          fi
      
      # --------------------------------------
      # 4. BOM ì œê±° (ìˆìœ¼ë©´)
      # --------------------------------------
      - name: Remove BOM
        run: |
          if [ -f data/patents.json ]; then
            sed -i '1s/^\xEF\xBB\xBF//' data/patents.json
            echo "BOM removed"
          fi
      
      # --------------------------------------
      # 5. JSON ìœ íš¨ì„± ê²€ì‚¬
      # --------------------------------------
      - name: Verify JSON
        run: |
          if command -v jq &> /dev/null; then
            if jq empty data/patents.json 2>/dev/null; then
              echo "JSON is valid"
              jq '.domesticReg | length' data/patents.json
            else
              echo "JSON is invalid"
              exit 1
            fi
          else
            echo "jq not found, installing..."
            sudo apt-get update -qq
            sudo apt-get install -y jq
            jq empty data/patents.json
          fi

# --------------------------------------
# 6. Commit & Push (ì¶©ëŒ ì•ˆ ë‚˜ê²Œ rebase)
# --------------------------------------
- name: Commit & Push changes
  run: |
    git config user.email "github-actions[bot]@users.noreply.github.com"
    git config user.name "github-actions[bot]"
    
    git add data/patents.json

    # ë³€ê²½ì´ ì—†ëŠ”ì§€ ì²´í¬
    if git diff --staged --quiet; then
      echo "No changes"
    else
      echo "Committing..."
      git commit -m "Update patents data"

      echo "Pulling latest changes to prevent conflicts..."
      git pull origin main --rebase   # âœ… commit í›„ ì‹¤í–‰ë¨

      echo "Pushing..."
      git push origin main
      echo "âœ… Update complete"
    fi

